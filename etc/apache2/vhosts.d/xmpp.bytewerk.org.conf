# Für Prosody:
# - LetsEncrypt-Zertifikat xmpp.bytewerk.org
# - Reverse Proxy für BOSH (unter https://xmpp.bytewerk.org/http-bind)
# - Reverse Proxy für BOSH-Autoconfiguration (XEP-0156)
# - Reverse Proxy für Websocket
# - Reverse Proxy für Pastebin (TODO!)

<VirtualHost *:80>
    ServerName xmpp.bytewerk.org

    ServerAdmin webmaster@bytewerk.org

    DocumentRoot /srv/var/www/vhosts/xmpp.bytewerk.org

    # Logging
    ErrorLog /var/log/apache2/xmpp.bytewerk.org-error_log
    CustomLog "|/usr/bin/python3 /usr/local/Anonip.git/anonip.py --skip-private --output /var/log/apache2/xmpp.bytewerk.org-access_log" combined env=!dontlog

    # don't loose time with IP address lookups
    HostnameLookups Off

    # needed for named virtual hosts
    UseCanonicalName Off

    ###############################

    # "Well-Known" URIs for service discovery (XEP-0156) autogenerated with Prosody's http_altconnect
    # http_altconnect setzt selbst CORS-Header
    RewriteEngine On
    RewriteCond %{REQUEST_URI} "^/.well-known/host-meta(\.json)?$"
    RewriteRule ^(.*)$ "http://localhost:5280/$1" [P]

    ###############################

    # Weiterleiten zu HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R=301,L]
</VirtualHost>


<VirtualHost *:443>
    ServerName xmpp.bytewerk.org

    ServerAdmin webmaster@bytewerk.org

    DocumentRoot /srv/var/www/vhosts/xmpp.bytewerk.org

    # enable HTTP/2, if available
    Protocols h2 http/1.1

    # Logging
    ErrorLog /var/log/apache2/xmpp.bytewerk.org-error_log
    CustomLog "|/usr/bin/python3 /usr/local/Anonip.git/anonip.py --skip-private --output /var/log/apache2/xmpp.bytewerk.org-access_log" combined env=!dontlog

    # don't loose time with IP address lookups
    HostnameLookups Off

    # needed for named virtual hosts
    UseCanonicalName Off

    # LetsEncrypt
    SSLCertificateFile /etc/letsencrypt/live/xmpp.bytewerk.org/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/xmpp.bytewerk.org/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    ###############################

    # Static root page
    <Location "/">
	Require all granted
	DirectoryIndex index.html
    </Location>




    #### Prosody ####
    # Reverse Proxy für BOSH und Websocket
    ProxyTimeout 900

    # BOSH
    <Location "/http-bind">
	ProxyPreserveHost on
	ProxyPass http://localhost:5280/http-bind
	ProxyPassReverse http://localhost:5280/http-bind
    </Location>

    <Location "/xmpp-websocket">
	ProxyPreserveHost On
	ProxyPass "ws://127.0.0.1:5280/xmpp-websocket"
    </Location>

    # "Well-Known" URIs for service discovery (XEP-0156) autogenerated with Prosody's http_altconnect module
    # Prosody-Modul "http_altconnect" setzt selbst CORS-Header
    ProxyPass /.well-known http://localhost:5280/.well-known
    ProxyPassReverse /.well-known http://localhost:5280/.well-known

    # Pastebin
    #ProxyPass /pastebin http://localhost:5280/pastebin
    #ProxyPassReverse /pastebin http://localhost:5280/pastebin




    #### MOVIM ####
    # Requires Service "Movim"
    # Movim configuration (taken from the Debian package)
    ProxyPass /movim/ws/ ws://127.0.0.1:8080/

    Alias /movim/ /usr/local/movim/public/
    <Directory /usr/local/movim/public>
	Options +FollowSymlinks -Indexes
	AllowOverride FileInfo Options
    </Directory>

    Alias /movim/cache/ /usr/local/movim/cache/
    <Directory /usr/local/movim/cache>
	Options -Indexes
    </Directory>

    <Location /movim/>
	Header set Access-Control-Allow-Origin "*"
	DirectoryIndex index.php
    </Location>




    #### CONVERSE.JS ####
    ### Converse.js configuration for Prosody's mod_conversejs

    ## ConverseJS CSS+JS files
    <Location /conversejs>
	ProxyPass http://localhost:5280/conversejs
	ProxyPassReverse http://localhost:5280/conversejs
    </Location>

    <Location /conversejs-bingo>
	# Prosody serves Converse.js configurations on all its VirtualHosts with appropriate settings. Default is "localhost"
	# Setting "bingo-ev.de" here switches to Converse.js configuration of Prosody's VirtualHost "bingo-ev.de" and allows @bingo-ev.de users to log in by just typing in their username instead of the full JID
	ProxyPreserveHost on
	RequestHeader set Host "bingo-ev.de"
	ProxyPass http://localhost:5280/conversejs
	ProxyPassReverse http://localhost:5280/conversejs
    </Location>

    # bytewerk.org settings
    <Location /conversejs-bytewerk>
	# Prosody serves Converse.js configurations on all its VirtualHosts with appropriate settings. Default is "localhost"
	# Setting "bytewerk.org" here switches to Converse.js configuration of Prosody's VirtualHost "bytewerk.org" and allows @bytewerk.org users to log in by just typing in their username instead of the full JID
	ProxyPreserveHost on
	RequestHeader set Host "bytewerk.org"
	ProxyPass http://localhost:5280/conversejs
	ProxyPassReverse http://localhost:5280/conversejs
    </Location>

    <Directory /usr/local/conversejs>
	Options +FollowSymlinks
    </Directory>

    # OMEMO support library for Converse.js
    Alias /conversejs-libsignal-protocol-javascript /usr/local/conversejs/libsignal-protocol-javascript/dist
    <Location /conversejs-libsignal-protocol-javascript>
	Require all granted
    </Location>

    # Workaround: Converse.js expects its sound files in /sounds/
    Alias /sounds /usr/local/conversejs/conversejs/package/dist
    <Location /sounds>
	Require all granted
    </Location>

    # Replace logo with custom iframe
    Alias /conversejs-custom /usr/local/conversejs/custom
    <Location /conversejs-custom>
	Require all granted
    </Location>

    # Redirect / to conversejs-bingo
    #RedirectMatch ^/$ /conversejs-bingo
</VirtualHost>
